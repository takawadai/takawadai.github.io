<html lang="ja">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">

<meta http-equiv="Content-Script-Type" content="text/javascript">
<title>Spoken Dialog by Javascript</title>
</head>
<body>

<h1>課題：音声対話　（ウエイクワード「OK コンピューター」）</h1>


<!--

参考文献：
	わだにゃんの部屋
	http://web.wakayama-u.ac.jp/mascot/index.html (2021年5月31日　参照）
-->
<p>
<button id="startButton">start</button>
<button id="stopButton">stop</button>
</p>

<p>
<div id="resultOutput"></div>
</p>

<script>

const URL = "https://jlp.yahooapis.jp/NLUService/V1/analyze?appid="; // APIのリクエストURL
const APIID = "dj00aiZpPUEzaktZVDEyUW5EZiZzPWNvbnN1bWVyc2VjcmV0Jng9MjY-"; // あなたのアプリケーションID
/*var response = {
    "誰":"わだにゃんにゃ",
    "何歳":"知らないにゃ",
    "元気":"元気にゃ",
    "好きな食べ物":"ミカンにゃ",
		"好きな場所":"図書館にゃ",
		"性別":"妖精だから性別がないにゃ",
		"好きな乗り物":"大学でお弁当売ってる車が好きにゃけどコロナのせいで学生がこにゃいから車がいなくなったにゃ",
		"仕事":"マスコットキャラやってるにゃけど最近は学生がこないから暇にゃ",
		"誕生日は":"気づいた時には和大にいたから知らないにゃ",
		"友達は":"マチカネワニくんにゃ"
};*/
var response = {
		"誰,あなた" : ["和歌山大学の案内をするわだにゃんにゃ", ""],
		"元気":["元気にゃ", ""],
		"好きな食べ物":["ミカンにゃ", ""],
		"好きな場所":["図書館にゃ", ""],
		"性別":["妖精だから性別がないにゃ", ""],
		"システム工学部,就職" : ["シス工の進路状況のページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/career/data.html"],
		"システム工学部,入試" : ["シス工の入試のページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/admission/index.html"],
		"シス工,ニュース" : ["シス工のニュースのページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/news/list/faculty/index.html"],
		"シス工,メジャー" : ["シス工のメジャーについてのページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/major/index.html"],
		"シス工,就職" : ["シス工の進路状況のページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/career/data.html"],
		"シス工,入試" : ["シス工の入試のページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/admission/index.html"],
		"シス工,ニュース" : ["シス工のニュースのページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/news/list/faculty/index.html"],
		"メジャー" : ["シス工のメジャーについてのページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/major/index.html"],
		"就職" : ["シス工の進路状況のページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/career/data.html"],
		"入試" : ["シス工の入試のページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/admission/index.html"],
		"ニュース" : ["シス工のニュースのページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/news/list/faculty/index.html"],
		"メジャー" : ["シス工のメジャーについてのページを表示するにゃ", "https://www.wakayama-u.ac.jp/sys/major/index.html"]
};


//var wake_word = "OK.*コンピューター";
const startButton = document.querySelector('#startButton'); // 開始ボタン
const stopButton = document.querySelector('#stopButton'); // 停止ボタン
const resultOutput = document.querySelector('#resultOutput'); // 結果出力エリア


if (!'SpeechSynthesisUtterance' in window) {
    alert("あなたのブラウザはSpeech Synthesis APIに未対応です。");
}
const tts = new SpeechSynthesisUtterance(); // TTSインスタンスを生成
//tts.text = textForm.value; // テキストを設定
tts.lang = "ja-JP"; // 言語(日本語)、英語の場合はen-US
tts.rate = 1.0; // 速度
tts.pitch = 1.0; // 声の高さ
tts.volume = 1.0; // 音量

SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;
if (!'SpeechRecognition' in window) {
    alert("あなたのブラウザはSpeech Recognition APIに未対応です。");
}

const asr = new SpeechRecognition(); // ASRインスタンスを生成
asr.lang = "ja-JP"; // 言語（日本語）
asr.interimResults = true; // 途中結果出力をオン
asr.continuous = true; // 継続入力をオン

let output = ''; // 出力

// 認識結果が出力されたときのイベントハンドラ
asr.onresult = function(event){
    let transcript = event.results[event.resultIndex][0].transcript; // 結果文字列
		let transcript_previous = null; // 結果文字列（ひとつ前）
		
		/*if(event.resultIndex > 0){
        transcript_previous = event.results[event.resultIndex - 1][0].transcript;
    }*/
		
    let output_not_final = '';
    if (event.results[event.resultIndex].isFinal) { // 結果が確定（Final）のとき
			 //if(new RegExp(wake_word).test(transcript_previous)){
				asr.abort(); // 音声認識を停止
				let ret = response[transcript];
				
					let answer;
					let webpage;
					
					let keys = Object.keys(response);
					keys.forEach(function(key) {
						 let flag = true;
						 console.log(transcript);
						 key.split(',').forEach(function(word) {              
								 let pattern = new RegExp(word);
								 let flag_test = pattern.test(transcript); // マッチしたらtrue, しなかったらfalse
								 flag = flag && flag_test; // 両方trueならtrue
								 console.log(pattern + '+' + ':' + flag_test);
						 });
						 
						 if(flag){
							 ret = response[key];
							 answer = ret[0];
							 webpage = ret[1];
							 
							 console.log('ret[0] = ' + ret[0]);
							 console.log('ret[1] = ' + ret[1]);
							 console.log('if文');
							}
					});
					
					if(typeof ret == 'undefined'){
					
						//answer = "ごめんなさい。わかりません。";
					   let queryURL = URL + APIID + "&intext=" + transcript;
							console.log(queryURL);
							
							const request = new XMLHttpRequest();
							request.open('GET', queryURL, true);
							console.log(request);
							request.responseType = 'json'; // レスポンスはJSON形式に変換
							
							request.onreadystatechange = function() {
								if (this.readyState == 4 && this.status == 200) {
									let res = this.response; // 結果はJSON形式
									console.log(res);

									
									Object.keys(res.result).forEach(function (key) {
									console.log(key + ": " + res.result[key])
									});
									
									if(res.result.method == "SAY"){
										answer = res.result.param_text_tts || res.result.param_text;
										tts.text = answer;
										console.log(answer);
									}
								}
							}
					}
					
				
					
				output += transcript + ' => ' + answer + '<br>';
				tts.text = answer;
					// 再生が終了（end）ときのイベントハンドラ（終了したときに実行される）
				tts.onend = function(event){
							if(typeof webpage != 'undefined'　&& webpage != ''){
									location.href = webpage; // ページを移動
							}   
							asr.start(); // 音声認識を再開 
				}
					
					
				speechSynthesis.speak(tts); // 再生
			//}
    } else { // 結果がまだ未確定のとき
        output_not_final = '<span style="color:#ddd;">' + transcript + '</span>';
    }
    resultOutput.innerHTML = output + output_not_final;
}

// 開始ボタンのイベントハンドラ
startButton.addEventListener('click', function() {
    asr.start();
		//tts.text = answer;
})

// 停止ボタンのイベントハンドラ
stopButton.addEventListener('click', function() {
　　　asr.abort();
   asr.stop();
		
})



</script>

<p>
Web Services by Yahoo! JAPAN （https://developer.yahoo.co.jp/about）
</p>

</body>
</html>
